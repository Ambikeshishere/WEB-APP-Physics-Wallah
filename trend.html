<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PW Live B2B & Target Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
    :root {
        --bg-dark: #020617;
        --card-bg: rgba(15, 23, 42, 0.75);
        --card-border: rgba(56, 189, 248, 0.2);
        --accent-primary: #38bdf8;
        --success: #4ade80;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --warning: #fb923c;
        --danger: #f87171;
    }

    * { box-sizing: border-box; }
    
    body {
        margin: 0; padding: 0;
        background: linear-gradient(-45deg, #020617, #0f172a, #1e293b, #020617);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        font-family: 'Outfit', sans-serif;
        color: var(--text-main);
        padding-bottom: 40px;
        min-height: 100vh;
    }

    @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    header { padding: 30px 20px; text-align: center; }
    h1 {
        font-size: 28px; font-weight: 700; margin: 0;
        background: linear-gradient(90deg, #38bdf8, #fb923c);
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        text-transform: uppercase; letter-spacing: 1px;
    }

    .container { padding: 15px; max-width: 1400px; margin: 0 auto; }
    .grid { display: grid; gap: 20px; }
    @media(min-width: 768px) { 
        .grid-2 { grid-template-columns: 1fr 1fr; } 
        .grid-3 { grid-template-columns: 1.2fr 1fr 1fr; }
        .grid-4 { grid-template-columns: repeat(4, 1fr); } 
    }

    .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        backdrop-filter: blur(12px);
        border-radius: 20px; padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .card h3 { 
        margin: 0 0 20px 0; font-size: 16px; font-weight: 600;
        display: flex; align-items: center; gap: 10px;
    }
    .card h3::before { content: ''; width: 4px; height: 18px; background: var(--accent-primary); border-radius: 10px; }

    /* Scroll Containers */
    .scroll-x-container { width: 100%; overflow-x: auto; cursor: grab; padding-bottom: 10px; }
    .scroll-y-container { width: 100%; overflow-y: auto; max-height: 550px; }
    
    .kpi-card { 
        background: rgba(0, 0, 0, 0.4); border-radius: 12px; padding: 15px; 
        text-align: center; border: 1px solid var(--card-border);
    }
    .kpi-label { font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 6px; letter-spacing: 1px;}
    .kpi-value { font-size: 20px; font-weight: 700; }

    select {
        width: 100%; padding: 12px; border-radius: 12px; background: #0f172a; color: white;
        border: 1px solid var(--card-border); margin-bottom: 20px; font-family: inherit; font-size: 14px;
    }

    .live-dot {
        height: 10px; width: 10px; background-color: #4ade80;
        border-radius: 50%; display: inline-block; margin-right: 8px;
        box-shadow: 0 0 10px #4ade80;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

    /* Table Styles */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; color: var(--text-muted); padding: 12px 8px; border-bottom: 1px solid var(--card-border); white-space: nowrap; }
    td { padding: 12px 8px; border-bottom: 1px solid rgba(148, 163, 184, 0.05); }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; }
    .badge-success { background: rgba(74, 222, 128, 0.1); color: #4ade80; border: 1px solid rgba(74, 222, 128, 0.2); }
    
    /* Pie Chart Container for Overlay */
    .pie-container { position: relative; height: 250px; width: 100%; }
    .pie-center-text {
        position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
        text-align: center; pointer-events: none;
    }
    .pie-percent { font-size: 28px; font-weight: 700; color: #f1f5f9; }
    .pie-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; }

    footer { text-align: center; font-size: 12px; color: var(--text-muted); margin-top: 40px; }
</style>
</head>

<body>

<header>
    <h1>PW Maharashtra Daily Trend</h1>
    <div style="font-size:14px; color:#94a3b8; margin-top:8px">
        <span class="live-dot"></span>SYSTEM STATUS: <span style="color:#4ade80">STREAMING LIVE DATA</span>
    </div>
</header>

<div class="container">
    <div class="grid grid-4" style="margin-bottom: 20px;">
        <div class="kpi-card"><div class="kpi-label">Total Target</div><div class="kpi-value" id="tTarget">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Total Achieved</div><div class="kpi-value" style="color:var(--accent-primary)" id="tAch">0</div></div>
        <div class="kpi-card"><div class="kpi-label">Avg Achievement</div><div class="kpi-value" style="color:var(--success)" id="tPct">0%</div></div>
        <div class="kpi-card"><div class="kpi-label">Total B2B Forms</div><div class="kpi-value" style="color:var(--warning)" id="tB2B">0</div></div>
    </div>

    <div class="card" style="margin-bottom: 20px;">
        <h3>üìà B2B Form Submission Trend (Scroll Right ‚Üí)</h3>
        <div class="scroll-x-container">
            <div style="width: 2800px; height: 350px;"> 
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="grid grid-3">
        <div class="card">
            <h3>üéÆ Center Completion Levels</h3>
            <div class="scroll-y-container">
                <div style="height: 1400px;"><canvas id="bar"></canvas></div>
            </div>
        </div>

        <div class="card">
            <h3>üéØ Overall Conversion</h3>
            <div class="pie-container">
                <canvas id="pie"></canvas>
                <div class="pie-center-text">
                    <div class="pie-percent" id="centerPct">0%</div>
                    <div class="pie-label">Completed</div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <div class="kpi-card" style="background:transparent">
                    <div class="kpi-label">Pending Gap</div>
                    <div class="kpi-value" id="tDelta" style="color:#f87171">0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>üîç Deep Dive Analysis</h3>
            <select id="centerSelect"><option value="">Detecting Centers...</option></select>
            
            <div class="grid grid-2" style="gap:10px;">
                <div class="kpi-card"><div class="kpi-label">Target</div><div class="kpi-value" id="cTarget">-</div></div>
                <div class="kpi-card" style="border-color:var(--accent-primary)"><div class="kpi-label">Achieved</div><div class="kpi-value" id="cAch" style="color:var(--accent-primary)">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Gap (Delta)</div><div class="kpi-value" id="cDelta" style="color:#f87171">-</div></div>
                <div class="kpi-card"><div class="kpi-label">Conversion %</div><div class="kpi-value" id="cPct" style="color:var(--success)">-</div></div>
            </div>
            
            <div class="kpi-card" style="margin-top:10px; border-color:var(--warning); background:rgba(251, 146, 60, 0.1)">
                <div class="kpi-label" style="color:var(--warning)">B2B Forms Filled</div>
                <div class="kpi-value" id="cB2B" style="color:var(--warning); font-size:24px">-</div>
            </div>
            
            <div style="height:150px; width:100%; margin-top:15px"><canvas id="centerPie"></canvas></div>
        </div>
    </div>

    <div class="grid grid-2" style="margin-top:20px">
        <div class="card">
            <h3>üèÜ Top 5 Performing Centers</h3>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Center</th><th>%</th><th>Target</th><th>Achieved</th></tr></thead>
                    <tbody id="topBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h3>‚ö†Ô∏è Zero Achievement (Action Required)</h3>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Center</th><th>Target</th><th>B2B Forms</th></tr></thead>
                    <tbody id="zeroBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <footer>
        Developed by Ambikesh Srivastava ‚Ä¢ Auto-syncing @ 0.5s ‚Ä¢ LAST HEARTBEAT: <span id="syncTime">--:--:--</span>
    </footer>
</div>

<script>
const csvURL="https://docs.google.com/spreadsheets/d/e/2PACX-1vTKpBKtR4FPQlTcRkMLLoyfPpsINfTUph6ZY-fZ15VlYmh5QGoOYZstOigBcCzIM3tWiMElXgrC7rIs/pub?gid=529778447&single=true&output=csv";
let barChart, pieChart, centerPieChart, lineChart;
let centersData = [];

function updateDashboard(){
    const liveURL = csvURL + "&cache=" + new Date().getTime();

    Papa.parse(liveURL, {
        download: true,
        complete: (res) => {
            const rows = res.data.filter(r => r.length > 3);
            if(rows.length < 2) return;

            const GT = rows[rows.length-1];
            
            // Global Values
            const totalTarget = +GT[1]||0;
            const totalAchieved = +GT[2]||0;
            const totalPct = GT[3] || "0%";
            
            document.getElementById("tTarget").innerText = totalTarget.toLocaleString();
            document.getElementById("tAch").innerText = totalAchieved.toLocaleString();
            document.getElementById("tPct").innerText = totalPct;
            document.getElementById("centerPct").innerText = totalPct; // For Pie Center
            document.getElementById("tDelta").innerText = (totalTarget - totalAchieved).toLocaleString();
            document.getElementById("tB2B").innerText = (+GT[5]||0).toLocaleString();
            document.getElementById("syncTime").innerText = new Date().toLocaleTimeString();

            centersData = [];
            for(let i=1; i<rows.length-1; i++){
                const r = rows[i];
                const t = +r[1]||0;
                const a = +r[2]||0;
                const b2b = +r[5]||0;
                const p = t > 0 ? (a/t)*100 : 0;
                const trophyName = p >= 100 ? "üèÜ " + r[0] : r[0];
                
                centersData.push({ 
                    name: r[0], 
                    displayName: trophyName,
                    target: t, 
                    achieved: a, 
                    remaining: Math.max(0, t - a),
                    pct: p, 
                    b2b: b2b,
                    delta: Math.max(0, t - a)
                });
            }

            const sortedData = [...centersData].sort((a,b) => b.pct - a.pct);

            // 1. LINE CHART (B2B)
            if(lineChart){
                lineChart.data.labels = centersData.map(d => d.name);
                lineChart.data.datasets[0].data = centersData.map(d => d.b2b);
                lineChart.update('none');
            } else {
                lineChart = new Chart(document.getElementById("lineChart"), {
                    type: 'line',
                    data: {
                        labels: centersData.map(d => d.name),
                        datasets: [{ 
                            label: 'B2B Forms', 
                            data: centersData.map(d => d.b2b), 
                            borderColor: '#fb923c', 
                            backgroundColor: 'rgba(251, 146, 60, 0.2)', 
                            fill: true, 
                            tension: 0.3,
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: '#fb923c'
                        }]
                    },
                    options: { 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false }, datalabels: { color: '#fff', align: 'top', font: {weight: 'bold'} } },
                        scales: {
                            x: { ticks: { color: '#94a3b8', font: {size: 11} }, grid: { display: false } },
                            y: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // 2. THICK STACKED BAR CHART
            if(barChart){
                barChart.data.labels = sortedData.map(d => d.displayName);
                barChart.data.datasets[0].data = sortedData.map(d => d.achieved);
                barChart.data.datasets[1].data = sortedData.map(d => d.remaining);
                barChart.update('none');
            } else {
                barChart = new Chart(document.getElementById("bar"), {
                    type:'bar',
                    data:{
                        labels: sortedData.map(d=>d.displayName),
                        datasets:[
                            { label:'Achieved', data:sortedData.map(d=>d.achieved), backgroundColor:'#38bdf8', borderRadius:4, barPercentage: 0.7, categoryPercentage: 0.85 },
                            { label:'Remaining', data:sortedData.map(d=>d.remaining), backgroundColor:'rgba(255,255,255,0.08)', borderRadius:4, barPercentage: 0.7, categoryPercentage: 0.85 }
                        ]
                    },
                    options:{
                        indexAxis:'y', maintainAspectRatio:false,
                        scales:{ 
                            x:{ stacked: true, display: false }, 
                            y:{ 
                                stacked: true, 
                                ticks:{ 
                                    color:'#f1f5f9', 
                                    font:{size:11, weight:'500'}, 
                                    crossAlign: 'far', 
                                    padding: 8,
                                    align: 'start'
                                }, 
                                grid:{ display: false } 
                            } 
                        },
                        plugins:{ 
                            legend: { display: false },
                            datalabels: { 
                                color: '#fff', 
                                font: { weight: 'bold', size: 11 },
                                formatter: (val, ctx) => ctx.datasetIndex === 0 ? (val > 0 ? val.toLocaleString() : '') : '' 
                            }
                        },
                        layout: { padding: { left: 10, right: 10, top: 5, bottom: 5 } }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // 3. PIE CHART WITH VALUES
            const pieData = [totalAchieved, Math.max(0, totalTarget - totalAchieved)];
            if(pieChart){
                pieChart.data.datasets[0].data = pieData;
                pieChart.update('none');
            } else {
                pieChart = new Chart(document.getElementById("pie"), {
                    type:'doughnut',
                    data:{
                        labels:['Achieved','Remaining'], 
                        datasets:[{
                            data: pieData, 
                            backgroundColor:['#38bdf8','rgba(255,255,255,0.05)'], 
                            borderWidth:0
                        }]
                    },
                    options:{
                        maintainAspectRatio:false, 
                        cutout:'75%', 
                        plugins:{
                            legend:{ display: true, position: 'bottom', labels: { color: '#94a3b8', font:{size:11} } }, 
                            datalabels:{
                                display: true,
                                color: '#fff',
                                font: { weight: 'bold', size: 14 },
                                formatter: (val) => val.toLocaleString() // Shows the exact number on the chart
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // 4. POPULATE TABLES
            document.getElementById("topBody").innerHTML = sortedData.slice(0,5).map(c => `
                <tr>
                    <td>${c.displayName}</td>
                    <td><span class="badge badge-success">${c.pct.toFixed(1)}%</span></td>
                    <td>${c.target.toLocaleString()}</td>
                    <td>${c.achieved.toLocaleString()}</td>
                </tr>
            `).join('');

            const zeroAch = centersData.filter(c => c.achieved === 0);
            document.getElementById("zeroBody").innerHTML = zeroAch.length > 0 ? zeroAch.map(c => `
                <tr>
                    <td style="color:#f87171">${c.name}</td>
                    <td>${c.target.toLocaleString()}</td>
                    <td style="color:var(--warning)">${c.b2b.toLocaleString()}</td>
                </tr>
            `).join('') : "<tr><td colspan='3' style='text-align:center; color:#4ade80'>Awesome! No centers with 0 admission.</td></tr>";

            // Dropdown Population (Only once)
            const select = document.getElementById("centerSelect");
            if(select.options.length <= 1){
                [...centersData].sort((a,b)=>a.name.localeCompare(b.name)).forEach(c => {
                    let opt=document.createElement("option"); opt.value=c.name; opt.innerText=c.name; select.appendChild(opt);
                });
            }
            
            const currentVal = select.value;
            if(currentVal) {
                const c = centersData.find(d => d.name === currentVal);
                if(c) updateCenterCards(c);
            }
        }
    });
}

function updateCenterCards(c) {
    document.getElementById("cTarget").innerText = c.target.toLocaleString();
    document.getElementById("cAch").innerText = c.achieved.toLocaleString();
    document.getElementById("cPct").innerText = c.pct.toFixed(1) + "%";
    document.getElementById("cDelta").innerText = c.delta.toLocaleString();
    document.getElementById("cB2B").innerText = c.b2b.toLocaleString();

    if(centerPieChart){
        centerPieChart.data.datasets[0].data = [c.achieved, c.delta];
        centerPieChart.update('none');
    } else {
        centerPieChart = new Chart(document.getElementById("centerPie"), {
            type:'doughnut',
            data: { datasets:[{data:[c.achieved, c.delta], backgroundColor:['#38bdf8','#1e293b'], borderWidth:0}]},
            options: { maintainAspectRatio:false, cutout:'70%', plugins:{legend:{display:false}, datalabels:{display:false}}}
        });
    }
}

document.getElementById("centerSelect").addEventListener("change", function(){
    const c = centersData.find(d => d.name === this.value);
    if(c) updateCenterCards(c);
});

updateDashboard();
setInterval(updateDashboard, 50000);
</script>
</body>
</html>